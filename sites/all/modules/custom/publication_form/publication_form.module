<?php

/**
 * Implements hook_preprocess_HOOK.
 * Adds necessary css for form of content type publication.
 *
 * @param $vars: The variables array (modify in place).
 */
function publication_form_preprocess_page(&$vars) {


    drupal_add_css(drupal_get_path('module', 'publication_form') . "/css/publication_form.css");

    /**
     * TODO: Auf Biblio Formularseite einschränken!
     * Vorläufige Lösung. Wird nicht ausgeführt, da node = null ist. CSS wird daher auf jeder Seite ausgeführt.
     * Als Admin werden die * in den Biblio Einstellungen angezeigt.
     * CSS suboptimal per n-th child.
     */
    if (isset($vars['node']) && $vars['node']->type == 'biblio_bibtex') {
        drupal_add_css(drupal_get_path('module', 'publication_form') . "/css/publication_form.css");
    }
}

/**
 * Implements hook_node_validate().
 *
 * $node: The node being validated.
 * $form: The form being used to edit the node.
 * $form_state: The form state array.
 */
function publication_form_node_validate($node, $form, &$form_state) {
    if(module_exists('biblio_bibtex')) {
        if ($form['#form_id'] === "biblio_node_form") {

            $year = array_key_exists('biblio_year', $form_state['values']) ? $form_state['values']['biblio_year'] : null;

            validateYear($year);


            $authors = array_key_exists('biblio_contributors', $form_state['values']) ? $form_state['values']['biblio_contributors'] : null;

            validateAuthors($authors);

        }
    }
}

function validateAuthors($authors) {

    if(!isset($authors)) { return; }

    $hasValue = FALSE;
    foreach ($authors as $author) {
        if (!empty($author['name'])) {
            $hasValue = TRUE;
        }
    }
    if (!$hasValue) {
        form_set_error('biblio_contributors', t('You must enter at least one author.'));
    }
}

function validateYear($year) {

    if (!isset($year)) { return; }

    if (!is_numeric($year)) {
        form_set_error('biblio_year', t('You have added an invalid date. Enter a year.'));
    } elseif ($year < '1800' ||  $year > '2200') {
        form_set_error('biblio_year', t('You have added an invalid date. Enter a year between 1800 and 2200.'));
    }

}

